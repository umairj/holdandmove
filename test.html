<!DOCTYPE html>
<html>
<head>
    <title></title>

    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />

    <script src="js/jquery-2.1.0.min.js"></script>
    <script src="js/test.js"></script>
    <script src="js/matrix.js"></script>

    <script>

        (function($) {



            $(document).on( 'onPan', function(event) {
                var $wrapper = $('#wrapper');
                var translation = {x: 0, y:0};
                translation.x = event.customData.navigationTouch.pageX - event.customData.lastNavigationTouchPosition.x;
                translation.y = event.customData.navigationTouch.pageY - event.customData.lastNavigationTouchPosition.y;

                if(!isNaN(translation.x) && !isNaN(translation.y)){
                    Matrix.translate(translation.x, translation.y);
                    Matrix.applyToElement($wrapper[0], true);
                }

            } );

            function distance(x1, y1, x2, y2) {
                return (x1-x2)*(x1-x2)+(y1-y2)*(y1-y2);
            }

            $(document).on( 'onDoTransformation', function(event) {
                var $wrapper = $('#wrapper');
                var oldTouches = [event.customData.lastNavigationTouchPosition, event.customData.lastActiveTouchPosition];
                var newTouches = [event.customData.navigationTouch, event.customData.activeTouch];
                var oldDistance = distance(oldTouches[0].x, oldTouches[0].y, oldTouches[1].x, oldTouches[1].y);
                var newDistance = distance(newTouches[0].pageX, newTouches[0].pageY, newTouches[1].pageX, newTouches[1].pageY);
                var origin = {
                    x: (newTouches[0].pageX + newTouches[1].pageX) / 2,
                    y: (newTouches[0].pageY + newTouches[1].pageY) / 2
                };
                var translation = {
                    x: (newTouches[0].pageX + newTouches[1].pageX) / 2 - (oldTouches[0].x + oldTouches[1].x) / 2,
                    y: (newTouches[0].pageY + newTouches[1].pageY) / 2 - (oldTouches[0].y + oldTouches[1].y) / 2
                };

                if(!isNaN(translation.x) && !isNaN(translation.y)){
                    Matrix.translate(translation.x, translation.y);
                }
                if(!isNaN(newDistance) && !isNaN(oldDistance) && oldDistance > 0) {
                    Matrix.translate(-origin.x, -origin.y);
                    Matrix.scale(Math.sqrt(newDistance / oldDistance));
                    Matrix.translate(origin.x, origin.y);
                }
                 Matrix.applyToElement($wrapper[0], true);
            } );

            $(document).on( 'onDrag', function(event) {

            } );

            $(document).on('onIdle', function () {

                var $wrapper = $('#wrapper');
                var matrixTranslation = Matrix.getTranslation();
                var matrixScale = Matrix.getScale();

                var translation = {x: 0, y: 0};
                var scale = 1;

                if(matrixScale < 1)
                    scale = 1 / matrixScale;

                if(matrixTranslation.x < window.innerWidth - $wrapper[0].offsetWidth * matrixScale) {
                    translation.x =   /*window.innerWidth - $wrapper[0].offsetWidth * matrixScale*/ - matrixTranslation.x /*- 2*$wrapper[0].offsetLeft*/;
                }

                if(matrixTranslation.y < window.innerHeight-$wrapper[0].offsetHeight * matrixScale) {


                    translation.y =    /*$wrapper[0].offsetHeight * matrixScale*/ - matrixTranslation.y /*+$wrapper[0].offsetTop*/;
                }


                if(matrixTranslation.x > 0) {
                    translation.x = -matrixTranslation.x;
                }

                if(matrixTranslation.y > 0) {
                    translation.y = -matrixTranslation.y;
                }



                if(!isNaN(translation.x) && !isNaN(translation.y))
                    //Matrix.translate(translation.x, translation.y);

                if(!isNaN(scale))
                   // Matrix.scale(scale);




                Matrix.applyToElement($wrapper[0], false);
            })

        })(jQuery);



    </script>

    <style>
        html, body {
            height: 100%;
        }
        #wrapper {
            background-color: #f00;
            height: 200%;
            border: 10px solid black;
        }
    </style>
</head>
<body>

    <!--<div id="debug"></div>-->

    <div id="wrapper">
        <div id="debug"></div>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>
        <p> asdfasdfasdfasdffsfds</p>

    </div>


</body>
</html>